# https://rdrr.io/cran/ecespa/man/syrjala.html
#https://esajournals.onlinelibrary.wiley.com/doi/abs/10.2307/2265656

#Computes a two-sample Cramer-von Mises (and Kolmogorov-Smirnov) type test 
#for a difference between the spatial distributions of two populations. 
#It is designed to be sensitive to differences in the way the populations are 
#distributed across the study area but insensitive to differences in abundance between the two populations.

library(ecespa)

stl_centroid_df <- readRDS("./Data/Full_city_centroid_df.RDS")
participant_centroid_df <- readRDS("./Data/Participant_centroid_df.RDS")


tmp <- data.frame(data.table(stl_centroid_df)[, .N, by = list(x, y)]) 
tmp2 <-data.frame(data.table(participant_centroid_df)[, .N, by = list(x, y)]) 


syr_frame <- data.frame("x" = c(tmp$x,
                                tmp2$x),
                        "y" = c(tmp$y,
                                tmp2$y),
                        "var1" = c(tmp$N, rep(0, nrow(tmp2))),
                        "var2" = c(rep(0, nrow(tmp)), tmp2$N))

full_sample <- data.table(syr_frame)[, .(sum(var1), sum(var2)), by = list(x, y)]


coords <- data.frame(full_sample[, c("x", "y")])                   
res <- syrjala(coords, full_sample$V1, full_sample$V2, nperm = nperm)                   
psi <- res$cvm.obs #psi
pvalue <- (sum(res$cvm.sim >=psi)+1)/nperm

plot(res)
res
